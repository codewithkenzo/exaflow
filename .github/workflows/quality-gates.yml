name: Quality Gates

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]

jobs:
  quality-check:
    name: Quality Gate Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: latest

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.bun/install/cache
        key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
        restore-keys: |
          ${{ runner.os }}-bun-

    - name: Install dependencies
      run: bun install --frozen-lockfile

    - name: Run type checking
      run: bun run typecheck

    - name: Run linting
      run: bun run lint

    - name: Run tests
      run: bun run test:ci

    - name: Check formatting
      run: bun run format:check

    - name: Generate coverage report
      run: bun run test:coverage

    - name: Coverage threshold check
      run: |
        echo "Checking coverage thresholds..."
        # Add coverage threshold validation here when reports are available

    - name: Security audit
      run: bun audit

    - name: Check for TODOs in source code
      run: |
        TODO_COUNT=$(grep -r "TODO\|FIXME\|XXX" src/ | wc -l || true)
        if [ "$TODO_COUNT" -gt 0 ]; then
          echo "âŒ Found $TODO_COUNT TODO/FIXME/XXX comments in source code"
          grep -rn "TODO\|FIXME\|XXX" src/ || true
          exit 1
        else
          echo "âœ… No TODO/FIXME/XXX comments found in source code"
        fi

    - name: Check for console.log statements
      run: |
        CONSOLE_COUNT=$(grep -r "console\.log\|console\.debug\|console\.warn" src/ | wc -l || true)
        if [ "$CONSOLE_COUNT" -gt 0 ]; then
          echo "âŒ Found $CONSOLE_COUNT console statements in source code"
          grep -rn "console\.log\|console\.debug\|console\.warn" src/ || true
          exit 1
        else
          echo "âœ… No console statements found in source code"
        fi

    - name: Check file sizes
      run: |
        echo "Checking file sizes..."
        find src/ -name "*.ts" -exec wc -l {} + | awk '{print $1}' | sort -nr | head -1 | while read lines; do
          if [ "$lines" -gt 500 ]; then
            echo "âš ï¸  Found file with $lines lines (consider refactoring)"
          fi
        done
        echo "âœ… File size check completed"

    - name: Validate package.json
      run: |
        echo "Validating package.json..."
        # Check if all scripts exist and are valid
        bun run build --dry-run 2>/dev/null || echo "Build script validation failed"

    - name: Quality Gate Summary
      run: |
        echo "## ðŸš€ Quality Gate Summary" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Type checking: Passed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Linting: Passed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Tests: Passed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Formatting: Passed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Security audit: Passed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Code quality checks: Passed" >> $GITHUB_STEP_SUMMARY